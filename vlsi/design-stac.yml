# Generate Make include to aid in flow
vlsi.core.build_system: make

technology.sky130.drc_blackbox_srams: true

# SRAMs for BIST module (since these aren't seen by macrocompiler)
# NOTE: this doesn't work so we add it directly to Makefile
# vlsi.inputs.sram_parameters: "stac-srams.json"
# vlsi.inputs.sram_parameters_meta: ["transclude", "json2list", "prependlocal"]

# TDC
vlsi.technology.extra_libraries_meta: ["append", "deepsubst"]
vlsi.technology.extra_libraries:
  - library:
      nldm_liberty_file: /tools/C/rahulkumar/personal/tdc_sky130_macros/tdc_64/tdc_64.lib
      verilog_sim: /tools/C/rahulkumar/personal/tdc_sky130_macros/tdc_64/tdc_64.v
      lef_file: /tools/C/rahulkumar/personal/tdc_sky130_macros/tdc_64/tdc_64.lef
      spice_file: /tools/C/rahulkumar/personal/tdc_sky130_macros/tdc_64/tdc_64.spice
      gds_file: /tools/C/rahulkumar/personal/tdc_sky130_macros/tdc_64/tdc_64.gds      
      corner: {nmos: typical, pmos: typical, temperature: "025 C"}
      supplies: {VDD: "1.80 V", GND: "0 V"}
      provides: [ {lib_type: stdcell, vt: RVT} ]

vlsi.inputs:
  power_spec_type: cpf
  power_spec_mode: auto
  supplies:
    power:
      - {name: "VDD", pin: "VDD"}
    ground:
      - {name: "VSS", pin: "VSS"}
    VDD: "1.8 V"
    GND: "0 V"

  top_module: ChipTop

  clocks:
    - {name: "clock_clock", period: "20ns", uncertainty: "1ns"} # temporary

  pin_mode: none

  placement_constraints:
    - path: ChipTop
      type: toplevel
      x: 0
      y: 0
      width: 3588
      height: 5188
      # margins: {left: 20, bottom: 20,
      #           right: 0, # must be 0 so that power pins (to power straps) are created
      #           top: 3500} 
      margins: {left: 249.78, right: 249.78, bottom: 252.08,
                top: 3000} # block off as much as possible for test SRAMs/analog

    # Place SRAM memory instances

    # TODO: improve sram placements

    # backing scratchpad
    - {path: ChipTop/system/subsystem_mbus/spad/backingscratchpad/backingscratchpad_ext/mem_0_0, type: hardmacro, 
      x: 2900, y: 1500, orientation: r270}
    
    # dcache
    - {path: ChipTop/system/tile_prci_domain/tile_reset_domain_tile/dcache/data/data_arrays_0/backingscratchpad_ext/mem_0_0, type: hardmacro, 
      x: 500, y: 255, orientation: my90}
    - {path: ChipTop/system/tile_prci_domain/tile_reset_domain_tile/dcache/tag_array_0/tag_array_0_ext/mem_0_0, type: hardmacro, 
      x: 720, y: 800, orientation: my90}

    # TODO: place icache now that the sram exists again
    # icache
    - {path: ChipTop/system/tile_prci_domain/tile_reset_domain_tile/frontend/icache/data_arrays_0_0/data_arrays_0_0_ext/mem_0_0, type: hardmacro, 
      x: 2525, y: 255, orientation: r270}
    - {path: ChipTop/system/tile_prci_domain/tile_reset_domain_tile/frontend/icache/data_arrays_1_0/data_arrays_0_0_ext/mem_0_0, type: hardmacro, 
      x: 2880, y: 255, orientation: my90}
    - {path: ChipTop/system/tile_prci_domain/tile_reset_domain_tile/frontend/icache/tag_array_0/tag_array_0_0_ext/mem_0_0, type: hardmacro, 
      x: 3100, y: 850, orientation: r270}
    
    # test srams
    - {path: ChipTop/system/sramBistClockDomainWrapper/sram_bist_0/sramBist/bistTop/srams_0/inner, type: hardmacro, 
      x: 250, y: 1100, orientation: my90}
    - {path: ChipTop/system/sramBistClockDomainWrapper/sram_bist_0/sramBist/bistTop/srams_1/inner, type: hardmacro, 
      x: 250, y: 1400, orientation: my90}

    # TODO: place TDC?
    - {path: ChipTop/system/sramBistClockDomainWrapper/sram_bist_0/sramBist/bistTop/harnesses_0/tdc, type: hardmacro, 
      x: 800, y: 1700, orientation: mx}
    - {path: ChipTop/system/sramBistClockDomainWrapper/sram_bist_0/sramBist/bistTop/harnesses_1/tdc, type: hardmacro, 
      x: 800, y: 1900, orientation: mx}
    
 
# Power Straps
par.power_straps_mode: generate
par.generate_power_straps_method: by_tracks
par.blockage_spacing: 2.0
par.blockage_spacing_top_layer: met3
par.generate_power_straps_options:
  by_tracks:
    strap_layers:
      - met4
      - met5
    pin_layers:
      - met5
    blockage_spacing_met2: 4.0
    blockage_spacing_met4: 2.0
    track_width: 3
    track_width_met5: 1
    track_spacing: 5
    track_start: 10
    track_start_met5: 1
    power_utilization: 0.1
    power_utilization_met4: 0.1
    power_utilization_met5: 0.1

# Pin placement constraints
vlsi.inputs.pin_mode: generated
vlsi.inputs.pin.generate_mode: semi_auto
vlsi.inputs.pin.assignments: [
  {pins: "*", layers: ["met2", "met4"], side: "bottom"}
]